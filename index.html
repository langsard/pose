<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pose Detector</title>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.8.0"></script>

  <!-- MoveNet Lightning (correct model) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>

  <style>
    body { font-family: Arial; margin: 20px; }
    .row { display: flex; gap: 20px; }
    img, canvas { width: 350px; border: 1px solid #ccc; }
    table { margin-top: 20px; border-collapse: collapse; }
    td, th { border: 1px solid #444; padding: 6px 10px; }
  </style>
</head>
<body>

<h2>Pose Estimator (Front + Side)</h2>

<div>
  <p><b>Upload Front View:</b></p>
  <input type="file" id="frontInput" accept="image/*">
  <br><br>
  <p><b>Upload Side View:</b></p>
  <input type="file" id="sideInput" accept="image/*">
</div>

<br>
<button id="runBtn">Run Detection</button>

<h3>Results</h3>

<div class="row">
  <div>
    <h4>Front</h4>
    <img id="frontImg">
    <canvas id="frontCanvas"></canvas>
  </div>

  <div>
    <h4>Side</h4>
    <img id="sideImg">
    <canvas id="sideCanvas"></canvas>
  </div>
</div>

<h3>Keypoint Table</h3>
<table id="keyTable"></table>

<script>
/* ------------------- LOAD MODEL ------------------- */
let detector;

async function loadModel() {
  detector = await poseDetection.createDetector(
    poseDetection.SupportedModels.MoveNet,
    { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING }
  );
  console.log("MoveNet Loaded");
}
loadModel();

/* ------------ Load images into <img> elements ------------ */
function loadImage(input, imgElement) {
  input.addEventListener("change", () => {
    const file = input.files[0];
    imgElement.src = URL.createObjectURL(file);
  });
}

loadImage(document.getElementById("frontInput"), document.getElementById("frontImg"));
loadImage(document.getElementById("sideInput"), document.getElementById("sideImg"));

/* ------------------- Draw Skeleton ------------------- */
function drawSkeleton(ctx, keypoints) {
  const edges = [
    [0,1], [1,3], [0,2], [2,4],     // eyes, ears
    [5,7], [7,9],                   // left arm
    [6,8], [8,10],                  // right arm
    [5,6],                          // shoulders
    [5,11], [6,12],                 // torso
    [11,12],
    [11,13], [13,15],               // left leg
    [12,14], [14,16]                // right leg
  ];

  ctx.fillStyle = "red";
  ctx.strokeStyle = "lime";
  ctx.lineWidth = 3;

  keypoints.forEach(p => {
    ctx.beginPath();
    ctx.arc(p.x, p.y, 4, 0, 2 * Math.PI);
    ctx.fill();
  });

  edges.forEach(([a,b]) => {
    const p = keypoints[a];
    const q = keypoints[b];
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    ctx.lineTo(q.x, q.y);
    ctx.stroke();
  });
}

/* ------------------- Pose Detection ------------------- */
async function detect(imageElement, canvas) {
  if (!detector) {
    alert("Model not loaded yet!");
    return null;
  }

  const poses = await detector.estimatePoses(imageElement);
  if (!poses.length) return null;

  const ctx = canvas.getContext("2d");
  canvas.width = imageElement.width;
  canvas.height = imageElement.height;
  ctx.drawImage(imageElement, 0, 0);

  const keypoints = poses[0].keypoints.map(p => ({
    x: p.x,
    y: p.y,
    score: p.score
  }));

  drawSkeleton(ctx, keypoints);
  return keypoints;
}

/* ------------------- Table Output ------------------- */
function updateTable(frontKP, sideKP) {
  const table = document.getElementById("keyTable");
  table.innerHTML = "";

  const header = `
    <tr>
      <th>Joint</th>
      <th>Front (x,y)</th>
      <th>Side (x,y)</th>
    </tr>`;
  table.insertAdjacentHTML("beforeend", header);

  const names = [
    "Nose","Left Eye","Right Eye","Left Ear","Right Ear",
    "Left Shoulder","Right Shoulder","Left Elbow","Right Elbow",
    "Left Wrist","Right Wrist","Left Hip","Right Hip",
    "Left Knee","Right Knee","Left Ankle","Right Ankle"
  ];

  for (let i = 0; i < 17; i++) {
    table.insertAdjacentHTML(
      "beforeend",
      `<tr>
         <td>${names[i]}</td>
         <td>${frontKP ? `${frontKP[i].x.toFixed(1)}, ${frontKP[i].y.toFixed(1)}` : "-"}</td>
         <td>${sideKP ? `${sideKP[i].x.toFixed(1)}, ${sideKP[i].y.toFixed(1)}` : "-"}</td>
       </tr>`
    );
  }
}

/* ------------------- Main Button ------------------- */
document.getElementById("runBtn").addEventListener("click", async () => {
  const frontImg = document.getElementById("frontImg");
  const sideImg = document.getElementById("sideImg");

  if (!frontImg.src || !sideImg.src) {
    alert("Upload both images first!");
    return;
  }

  const frontKP = await detect(frontImg, document.getElementById("frontCanvas"));
  const sideKP = await detect(sideImg, document.getElementById("sideCanvas"));

  updateTable(frontKP, sideKP);

  console.log("Front keypoints:", frontKP);
  console.log("Side keypoints:", sideKP);
});
</script>

</body>
</html>
